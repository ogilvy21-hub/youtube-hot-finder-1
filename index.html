<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YouTube Hot Finder – Web (쿼터 최적화)</title>
<style>
  :root { --bg:#0b0e13; --card:#121821; --ink:#e8eef7; --muted:#9cb0c9; --brand:#3ea6ff; --accent:#2dd4bf; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;gap:8px;padding:12px;border-bottom:1px solid #1f2a37;background:#0d141d;position:sticky;top:0;z-index:2}
  .btn{background:#1a2230;color:#e8eef7;border:1px solid #263244;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn[aria-pressed="true"]{outline:2px solid var(--brand)}
  .container{display:flex;gap:12px;padding:12px}
  .panel{background:var(--card);border:1px solid #1f2a37;border-radius:14px;padding:12px}
  #left{flex:1 1 auto;min-width:0}
  #right{flex:0 0 340px} /* 미리보기 확 줄임 */
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  input,select{background:#0f1520;color:var(--ink);border:1px solid #273142;border-radius:10px;padding:9px 12px}
  input[type="text"],input[type="search"]{min-width:420px}
  table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
  th,td{border-bottom:1px solid #202a38;padding:7px 8px;vertical-align:middle}
  th{position:sticky;top:0;background:#0f1620;text-align:left;z-index:1}
  tr:hover{background:#0f1620}
  .clip{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .w-200{width:200px}.w-320{width:320px}.w-140{width:140px}.w-110{width:110px}.w-90{width:90px}.w-80{width:80px}
  .preview{position:relative;padding-top:56.25%;border-radius:10px;overflow:hidden;background:#0b1220;border:1px solid #1f2a37}
  .preview iframe{position:absolute;inset:0;width:100%;height:100%}
  footer{position:sticky;bottom:0;background:#0d141d;border-top:1px solid #1f2a37;padding:10px 12px}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #273142;background:#0f1520}
  .danger{border-color:#7b2631;background:#2b0d13;color:#ffb3c0}
  .brand{border-color:#234a66;background:#0b1620;color:#bfe6ff}
  .bad{border-color:#6b2424;background:#1a0f10;color:#ffb3b3}
  .ok{border-color:#1e4a35;background:#0f1e18;color:#b1ffe7}
</style>
</head>
<body>

<header>
  <button class="btn" id="tab-handle" aria-pressed="true">채널핸들명</button>
  <button class="btn" id="tab-keyword">키워드 입력</button>
  <button class="btn" id="tab-settings">설정</button>
  <button class="btn" id="tab-results">결과</button>
  <button class="btn" id="btn-trending" title="지역 인기 급상승 50개 빠르게">인기 급상승(KR)</button>
</header>

<div class="container">
  <section id="left" class="panel">
    <!-- TABs -->
    <div id="view-handle">
      <div class="row">
        <input id="handle-input" type="text" placeholder="@handle 여러 개는 쉼표로 (예: @veritasium, @Kurzgesagt)" />
        <button class="btn brand" id="btn-search-handle">검색</button>
      </div>
    </div>

    <div id="view-keyword" hidden>
      <div class="row">
        <input id="keyword-input" type="search" placeholder="키워드 여러 개는 쉼표로 (예: 시니어, 뉴스)" />
        <button class="btn brand" id="btn-search-keyword">검색</button>
      </div>
    </div>

    <div id="view-settings" hidden>
      <div class="row">
        <label class="pill">조회수 필터:
          <select id="view-filter" style="margin-left:8px">
            <option value="100k">10만 이상</option>
            <option value="500k">50만 이상</option>
            <option value="1m">100만 이상</option>
            <option value="spike" selected>실시간 급등(24h·≥5,000/h)</option>
          </select>
        </label>
        <label class="pill">키워드 기간(시간):
          <select id="kw-hours" style="margin-left:8px">
            <option value="24">24</option>
            <option value="48" selected>48</option>
            <option value="72">72</option>
          </select>
        </label>
        <span class="muted">※ 채널 수집은 고비용 `search.list` 대신 업로드 플레이리스트 경로 사용</span>
      </div>
    </div>

    <div id="view-results" hidden>
      <div class="muted" style="margin-bottom:8px">최근 검색 결과</div>
    </div>

    <!-- SUMMARY -->
    <div id="summary" class="muted" style="margin:6px 0 8px"></div>

    <!-- TABLE -->
    <div style="overflow:auto; max-height:58vh; border:1px solid #1f2a37; border-radius:10px">
      <table id="results">
        <thead>
          <tr>
            <th class="w-200">채널명</th>
            <th class="w-320">제목</th>
            <th class="w-140">업로드일</th>
            <th class="w-110">조회수</th>
            <th class="w-140">시간당 조회수</th>
            <th class="w-110">구독자수</th>
            <th class="w-90">영상길이</th>
            <th class="w-90">영상링크</th>
            <th class="w-110">썸네일링크</th>
            <th class="w-80">출처</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <aside id="right" class="panel">
    <div class="muted" style="margin-bottom:8px">영상 미리보기</div>
    <div class="preview" id="preview"></div>
    <div id="preview-title" class="clip" style="margin-top:8px; font-weight:600" title=""></div>
  </aside>
</div>

<footer>
  <div class="row">
    <input id="api-key" type="text" placeholder="YouTube Data API v3 Key (여기에 붙여넣기)" style="min-width:360px">
    <button class="btn" id="btn-save-key">키 저장</button>
    <button class="btn" id="btn-clear-key">키 지우기</button>
    <span class="muted">브라우저 <b>로컬</b>에만 저장됩니다.</span>
  </div>
  <div class="row">
    <button class="btn" id="btn-start">시작하기(자동 새로고침)</button>
    <button class="btn" id="btn-stop">정지하기</button>
    <button class="btn danger" id="btn-clear">결과 지우기</button>
    <button class="btn" id="btn-export">엑셀로 저장(CSV)</button>
    <button class="btn" id="btn-save-job">현재작업 저장(JSON)</button>
    <input type="file" id="load-file" accept=".json" hidden />
    <button class="btn" id="btn-load-job">작업 불러오기</button>
    <span id="quota-hint" class="muted"></span>
  </div>
  <div class="muted">© YouTube Hot Finder – Web. For research & analytics. Use responsibly.</div>
</footer>

<script>
/* ====== 설정(필요시 숫자만 바꾸세요) ====== */
const MAX_UPLOAD_PAGES = 2;    // 채널별 playlistItems 페이지 수(50개/페이지). 비용 매우 낮음.
const MAX_SEARCH_PAGES = 1;    // 키워드 search.list 페이지 수(비용 100/페이지, 아껴야 함).
const SPIKE_VPH = 5000;        // 실시간 급등 임계(시간당 조회수)
const SPIKE_MAX_HOURS = 24;    // 실시간 급등 인정 기간(업로드 24시간)
const TREND_REGION = 'KR';     // 인기 급상승 지역 코드

/* ====== 유틸 ====== */
const $ = s => document.querySelector(s);
const fmt = n => Number(n||0).toLocaleString('en-US');
const isoToLocal = iso => new Date(iso).toLocaleString();
const uniq = arr => [...new Set(arr)];
function isoDurationToHHMMSS(iso) {
  const m = iso?.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  const h = String(parseInt(m?.[1]||0)).padStart(2,'0');
  const mm = String(parseInt(m?.[2]||0)).padStart(2,'0');
  const s = String(parseInt(m?.[3]||0)).padStart(2,'0');
  return `${h}:${mm}:${s}`;
}
function hoursBetween(nowISO, pastISO) {
  const diff = new Date(nowISO) - new Date(pastISO);
  return Math.max(1, diff / (1000*60*60));
}
function okToast(msg, cls=''){
  const el = document.createElement('div');
  el.textContent = msg; el.className = cls;
  el.style.cssText = 'position:fixed;right:12px;bottom:12px;background:#102232;color:#bfe6ff;border:1px solid #264968;padding:10px 12px;border-radius:10px;z-index:9999';
  document.body.appendChild(el); setTimeout(()=>el.remove(), 2000);
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* API 키 */
const apiKeyInput = $('#api-key');
apiKeyInput.value = localStorage.getItem('yt_api_key') || '';
$('#btn-save-key').onclick = () => { localStorage.setItem('yt_api_key', apiKeyInput.value.trim()); okToast('API 키 저장됨','ok'); };
$('#btn-clear-key').onclick = () => { localStorage.removeItem('yt_api_key'); apiKeyInput.value=''; okToast('API 키 삭제됨'); };

async function fetchJSON(url){
  const res = await fetch(url);
  const j = await res.json().catch(()=> ({}));
  if (!res.ok || j?.error) throw new Error(j?.error?.message || `HTTP ${res.status}`);
  return j;
}

/* ====== 탭 ====== */
const tabs = [['tab-handle','view-handle'], ['tab-keyword','view-keyword'], ['tab-settings','view-settings'], ['tab-results','view-results']];
tabs.forEach(([b,v]) => $('#'+b).onclick = () => tabs.forEach(([bb,vv]) => {
  $('#'+bb).setAttribute('aria-pressed', bb===b ? 'true' : 'false');
  $('#'+vv).hidden = vv!==v;
}));

/* ====== 상태 ====== */
let lastQuery = null;   // {mode: 'handle'|'keyword'|'trending', ...}
let timer = null;
let rows = [];
let _rawFilled = [];    // 최종 필터 전 원본
let _estUnits = 0;      // 대략적 비용 추정

function renderSummary(total, shown, mode){
  $('#summary').textContent = `총 ${fmt(total)}건 수집 / 필터 통과 ${fmt(shown)}건 (필터: ${mode})  |  대략적 API 유닛 ≈ ${fmt(_estUnits)}`;
}
function renderTable(data){
  const tb = $('#tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="clip w-200" title="${escapeHtml(r.channelTitle||'')}">${escapeHtml(r.channelTitle||'')}</td>
      <td class="clip w-320" title="${escapeHtml(r.title||'')}">${escapeHtml(r.title||'')}</td>
      <td class="clip w-140">${isoToLocal(r.publishedAt||'')}</td>
      <td class="clip w-110">${fmt(r.viewCount)}</td>
      <td class="clip w-140">${fmt(r.viewsPerHour)}</td>
      <td class="clip w-110">${fmt(r.subscriberCount)}</td>
      <td class="clip w-90">${r.duration||''}</td>
      <td class="clip w-90"><a href="${r.videoUrl}" target="_blank">열기</a></td>
      <td class="clip w-110"><a href="${r.thumbnailUrl}" target="_blank">보기</a></td>
      <td class="clip w-80">${r.source||'youtube'}</td>`;
    tr.onclick = ()=>showPreview(r);
    tb.appendChild(tr);
  });
}
function showPreview(r){
  $('#preview').innerHTML = `<iframe src="https://www.youtube.com/embed/${r.videoId}" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>`;
  const t = r.title||''; const el = $('#preview-title'); el.textContent = t; el.title = t;
}
function passesFilter(r, mode){
  if (mode === '100k') return (r.viewCount||0) >= 100000;
  if (mode === '500k') return (r.viewCount||0) >= 500000;
  if (mode === '1m')   return (r.viewCount||0) >= 1000000;
  if (mode === 'spike') {
    const ageH = hoursBetween(new Date().toISOString(), r.publishedAt);
    return ageH <= SPIKE_MAX_HOURS && (r.viewsPerHour||0) >= SPIKE_VPH;
  }
  return true;
}
function applyFilterAndRender(){
  const mode = ($('#view-filter').value || 'spike');
  let shown = _rawFilled.filter(r => passesFilter(r, mode));
  if (!shown.length && mode==='spike'){
    shown = _rawFilled.filter(r => passesFilter(r,'100k'));
    okToast('실시간 급등 결과가 없어 “10만 이상”으로 자동 전환했습니다.');
  }
  rows = shown.sort((a,b)=> mode==='spike' ? (b.viewsPerHour||0)-(a.viewsPerHour||0) : (b.viewCount||0)-(a.viewCount||0));
  renderSummary(_rawFilled.length, rows.length, mode);
  renderTable(rows);
  if (rows[0]) showPreview(rows[0]);
}
$('#view-filter').onchange = applyFilterAndRender;

/* ====== YouTube API 래퍼(쿼터 최적화) ====== */
const API = {
  key(){ const k = apiKeyInput.value.trim(); if(!k) throw new Error('하단에 API 키를 입력하세요.'); return k; },

  async channelByHandle(handle){
    const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,contentDetails&forHandle=${encodeURIComponent(handle)}&key=${this.key()}`;
    // contentDetails 같이 받아 비용 1로 핸들+구독자+업로드 플레이리스트 모두 확보
    const data = await fetchJSON(url); _estUnits += 1;
    const ch = data.items?.[0];
    if(!ch) throw new Error(`채널 없음: ${handle}`);
    return {
      id: ch.id,
      title: ch.snippet.title,
      subs: Number(ch.statistics?.subscriberCount||0),
      uploads: ch.contentDetails?.relatedPlaylists?.uploads
    };
  },

  async listUploadsVideos(uploadsPlaylistId){
    let token=null, all=[]; let pages=0;
    for (let p=0; p<MAX_UPLOAD_PAGES; p++){
      const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${uploadsPlaylistId}&maxResults=50${token?`&pageToken=${token}`:''}&key=${this.key()}`;
      const data = await fetchJSON(url); _estUnits += 1; pages++;
      all = all.concat((data.items||[]).map(i=>({
        videoId: i.contentDetails?.videoId,
        publishedAt: i.contentDetails?.videoPublishedAt || i.snippet?.publishedAt,
        title: i.snippet?.title,
        channelTitle: i.snippet?.channelTitle,
        channelId: i.snippet?.channelId,
        thumbnailUrl: i.snippet?.thumbnails?.medium?.url || i.snippet?.thumbnails?.default?.url
      })));
      token = data.nextPageToken;
      if(!token) break;
    }
    return all;
  },

  async searchByKeyword(q, hoursWindow){
    const after = new Date(Date.now()-hoursWindow*3600*1000).toISOString();
    let token=null, all=[];
    for (let p=0; p<MAX_SEARCH_PAGES; p++){
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&order=date&publishedAfter=${encodeURIComponent(after)}&maxResults=50&q=${encodeURIComponent(q)}${token?`&pageToken=${token}`:''}&key=${this.key()}`;
      const data = await fetchJSON(url); _estUnits += 100; // search.list 비용
      all = all.concat((data.items||[]).map(i=>({
        videoId: i.id?.videoId,
        publishedAt: i.snippet?.publishedAt,
        title: i.snippet?.title,
        channelTitle: i.snippet?.channelTitle,
        channelId: i.snippet?.channelId,
        thumbnailUrl: i.snippet?.thumbnails?.medium?.url || i.snippet?.thumbnails?.default?.url
      })));
      token = data.nextPageToken;
      if(!token) break;
    }
    return all;
  },

  async trendingMostPopular(regionCode='KR'){
    const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&chart=mostPopular&regionCode=${regionCode}&maxResults=50&key=${this.key()}`;
    const data = await fetchJSON(url); _estUnits += 1;
    return (data.items||[]).map(v=>({
      videoId: v.id,
      publishedAt: v.snippet?.publishedAt,
      title: v.snippet?.title,
      channelTitle: v.snippet?.channelTitle,
      channelId: v.snippet?.channelId,
      thumbnailUrl: v.snippet?.thumbnails?.medium?.url || v.snippet?.thumbnails?.default?.url,
      duration: isoDurationToHHMMSS(v.contentDetails?.duration || 'PT0S'),
      viewCount: Number(v.statistics?.viewCount||0),
      videoUrl: `https://www.youtube.com/watch?v=${v.id}`,
      source: 'trending'
    }));
  },

  async fillVideoDetails(baseRows){
    const ids = uniq(baseRows.map(r=>r.videoId).filter(Boolean));
    const nowISO = new Date().toISOString();
    for (let i=0; i<ids.length; i+=50){
      const slice = ids.slice(i, i+50);
      const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics,snippet&id=${slice.join(',')}&key=${this.key()}`;
      const data = await fetchJSON(url); _estUnits += 1;
      const map = Object.create(null);
      (data.items||[]).forEach(v=>{
        map[v.id] = {
          duration: v.contentDetails?.duration || 'PT0S',
          views: Number(v.statistics?.viewCount||0),
          chTitle: v.snippet?.channelTitle,
          chId: v.snippet?.channelId,
          thumb: v.snippet?.thumbnails?.medium?.url || v.snippet?.thumbnails?.default?.url,
          publishedAt: v.snippet?.publishedAt
        };
      });
      baseRows = baseRows.map(r=>{
        if (!slice.includes(r.videoId)) return r;
        const d = map[r.videoId] || {};
        const published = r.publishedAt || d.publishedAt;
        const vph = d.views ? Math.round(d.views / hoursBetween(nowISO, published)) : 0;
        return {
          ...r,
          channelTitle: r.channelTitle || d.chTitle,
          channelId: r.channelId || d.chId,
          thumbnailUrl: r.thumbnailUrl || d.thumb,
          duration: isoDurationToHHMMSS(d.duration),
          viewCount: d.views||0,
          viewsPerHour: vph,
          publishedAt: published,
          videoUrl: `https://www.youtube.com/watch?v=${r.videoId}`,
          source: r.source || 'youtube'
        };
      });
    }
    return baseRows;
  },

  async enrichSubscribers(baseRows){
    const ids = uniq(baseRows.map(r=>r.channelId).filter(Boolean));
    for (let i=0; i<ids.length; i+=50){
      const slice = ids.slice(i, i+50);
      const url = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${slice.join(',')}&key=${this.key()}`;
      const data = await fetchJSON(url); _estUnits += 1;
      const dict = Object.create(null);
      (data.items||[]).forEach(ch=> dict[ch.id] = Number(ch.statistics?.subscriberCount||0));
      baseRows = baseRows.map(r => slice.includes(r.channelId) ? ({...r, subscriberCount: dict[r.channelId]||0}) : r);
    }
    return baseRows;
  }
};

/* ====== 실행 ====== */
async function runSearch(payload){
  try{
    const key = apiKeyInput.value.trim();
    if(!key){ okToast('하단에 API 키를 입력하세요.','bad'); return; }
    $('#tbody').innerHTML = `<tr><td colspan="10" class="muted">수집 중…</td></tr>`;
    _estUnits = 0;

    let base = [];
    if (payload.mode === 'handle'){
      // 여러 핸들을 병렬 수집(저비용 경로)
      const handles = payload.handles;
      const infos = await Promise.allSettled(handles.map(h=>API.channelByHandle(h)));
      const oks = infos.filter(x=>x.status==='fulfilled').map(x=>x.value);
      const perCh = await Promise.all(oks.map(ch=>API.listUploadsVideos(ch.uploads)));
      base = perCh.flat().map(r=>({ ...r, subscriberCount: oks.find(x=>x.id===r.channelId)?.subs || 0 }));
    } else if (payload.mode === 'keyword'){
      const qs = payload.queries;
      const hoursWindow = Number($('#kw-hours').value || 48);
      const perQ = await Promise.all(qs.map(q=>API.searchByKeyword(q, hoursWindow)));
      base = perQ.flat();
    } else if (payload.mode === 'trending'){
      base = await API.trendingMostPopular(TREND_REGION);
    }

    // 세부 정보(트렌드는 이미 포함되어 있어도 한 번 더 정규화)
    base = await API.fillVideoDetails(base);
    base = await API.enrichSubscribers(base);

    _rawFilled = base;
    applyFilterAndRender();
  }catch(err){
    console.error(err);
    const msg = String(err?.message||'알 수 없는 오류');
    okToast(msg, 'bad');
    $('#tbody').innerHTML = `<tr><td colspan="10" class="muted">오류: ${escapeHtml(msg)}</td></tr>`;
    renderSummary(0,0,$('#view-filter').value||'');
  }
}

/* 버튼 */
$('#btn-search-handle').onclick = ()=>{
  const raw = $('#handle-input').value.trim();
  const handles = raw.split(/[,\s]+/).filter(Boolean);
  if (!handles.length || !handles.every(h=>h.startsWith('@'))){
    okToast('@handle 형식으로, 여러 개는 쉼표로 입력','bad'); return;
  }
  lastQuery = {mode:'handle', handles};
  runSearch(lastQuery);
};
$('#btn-search-keyword').onclick = ()=>{
  const raw = $('#keyword-input').value.trim();
  const queries = raw.split(/[,\s]+/).filter(Boolean);
  if (!queries.length){ okToast('키워드를 입력','bad'); return; }
  lastQuery = {mode:'keyword', queries};
  runSearch(lastQuery);
};
$('#btn-trending').onclick = ()=>{
  lastQuery = {mode:'trending'};
  runSearch(lastQuery);
};

$('#btn-clear').onclick = ()=>{ rows=[]; _rawFilled=[]; $('#tbody').innerHTML=''; $('#preview').innerHTML=''; $('#preview-title').textContent=''; renderSummary(0,0,$('#view-filter').value||''); };
$('#btn-export').onclick = ()=>{
  if(!rows.length){ okToast('내보낼 데이터가 없습니다.','bad'); return; }
  const headers = ['채널명','제목','업로드일','조회수','시간당 조회수','구독자수','영상길이','영상링크','썸네일링크','출처'];
  const csv = [headers.join(',')].concat(rows.map(r=>[
    qq(r.channelTitle), qq(r.title), qq(isoToLocal(r.publishedAt)), r.viewCount, r.viewsPerHour, r.subscriberCount, r.duration, r.videoUrl, r.thumbnailUrl, r.source||'youtube'
  ].join(','))).join('\n');
  downloadFile('\ufeff'+csv,'text/csv;charset=utf-8',`hot-finder-${Date.now()}.csv`);
};
$('#btn-save-job').onclick = ()=> downloadFile(JSON.stringify(rows,null,2),'application/json',`hot-finder-${Date.now()}.json`);
$('#btn-load-job').onclick = ()=> $('#load-file').click();
$('#load-file').onchange = e=>{
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader(); fr.onload = ()=>{ try{ rows = JSON.parse(fr.result); _rawFilled=rows; applyFilterAndRender(); }catch(e){ okToast('JSON 파싱 오류','bad'); } }; fr.readAsText(f);
};

$('#btn-start').onclick = ()=>{
  if(!lastQuery){ okToast('먼저 한 번 검색을 실행하세요.','bad'); return; }
  if(timer) return; timer = setInterval(()=>runSearch(lastQuery), 15*60*1000); okToast('자동 새로고침 시작(15분)');
};
$('#btn-stop').onclick = ()=>{ if(timer){ clearInterval(timer); timer=null; okToast('자동 새로고침 정지'); } };

/* CSV 유틸 */
function qq(v){ const s = String(v??'').replace(/"/g,'""'); return `"${s}"`; }
function downloadFile(content, type, filename){
  const blob = new Blob([content], {type}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

/* 최초 요약 */
renderSummary(0,0,$('#view-filter').value||'spike');
</script>
</body>
</html>
